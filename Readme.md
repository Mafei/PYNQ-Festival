PYNQ-Festival
====================================================================================

Overview
------------------------------------------------------------------------------------

### Introduction

This Repository provides a Linux Boot Image(U-boot, Kernel, Root-fs) examples for PYNQ.

### Features

* Hardware
  + PYNQ-Z1 : Python Productive for Zynq by Digilent
* U-Boot v2016.03 (customized)
  + Build for ZYBO, PYNQ-Z1 and DE0-Nano-SoC
  + Customized boot by uEnv.txt
  + Customized boot by boot.scr
* Linux Kernel Version v4.8.17
  + Available in both Xilinx-Zynq-7000 and Altera-SoC in a single image
  + Enable Device Tree Overlay
  + Enable FPGA Manager
* Debian8(jessie) Root File System
  + Installed build-essential
  + Installed device-tree-compiler
  + Installed ruby ruby-msgpack ruby-serialport
  + Installed u-boot-tools
  + installed python3 pip3
  + installed Jupyter Notebook

Install
------------------------------------------------------------------------------------

### Downlowd from github

```
shell$ git clone git://github.com/ikwzm/FPGA-SoC-Linux
shell$ cd FPGA-SoC-Linux
shell$ git lfs pull origin master
```

### File Description

 * boot/
   + boot.bin                                  : Stage 1 Boot Loader(U-boot-spl)
   + u-boot.img                                : Stage 2 Boot Loader(U-boot)
   + uEnv.txt                                  : U-Boot environment variables for linux boot
   + zImage-4.8.17-armv7-fpga                  : Linux Kernel Image       
   + devicetree-4.8.17-zynq-pynqz1.dtb         : Linux Device Tree Blob   
   + devicetree-4.8.17-zynq-pynqz1.dts         : Linux Device Tree Source
 * debian8-rootfs-4.8.17.tgz                   : Debian8 Root File System (use Git LFS)
 * examples/
   + fibonacci                                 : Fibonacci Examples Directory
     - src/                                    : Fibonacci src/
       * main/                                 : Fibonacci src/main/
         + polyphony/                          : Fibonacci src/main/polyphony
           - Makefile                          : Makefile for generate *.v and *.vhd
           - fib.py                            : Fibonacci for polyphony
           - fib.yml                           : Fibonacci Interface configuration file
           - polyphony_out.v                   : Generated by polyphony
           - polyphony_out_fib.v               : Generated by polyphony
           - polyphony_out_test.v              : Generated by polyphony
           - fibonacci_interface.vhd           : Generated by msgpack-rpc-ifgen
           - fibonacci_server.vhd              : Generated by msgpack-rpc-ifgen
       * test/                                 : Fibonacci src/test/
         + vhdl/                               : Fibonacci src/test/vhdl
           - test_bench.vhd                    : Testbench for fibonacci_server
         + scenarios/                          : Fibonacci src/test/scenarios
           - test_42.rb                        : Test Scenario generator for fibonacci_server
           - test_42.snr                       : generated by test_42.rb
           - test_93.rb                        : Test Scenario generator for fibonacci_server
           - test_93.snr                       : generated by test_93.rb
     - fpga/
       * xilinx/
         + pynq_test_polyphony/                : Fibonacci server for PYNQ-Z1
           - ip/                               : IP Directory for Vivado
	     * fibonacci_server_ppy            : Fibonacci server IP 
	     * Makefile                        : Makefile for generate add_sources.tcl and msgpack.vhd
	     * add_sources.yml                 : Configuration file for generate add_sources.tcl and msgpack.vhd
	     * create_ip.tcl                   : Create IP script for Vivado
	     * add_sources.tcl                 : Generated by make
	     * msgpack.vhd                     : Generated by make
	   - project/                          : Project Directory for Vivado
	     * create_project.tcl              : Create Project script for Vivado
	     * implementation.tcl              : Implementation script for Vivado

### Format SD-Card

````
shell# fdisk /dev/sdc
   :
   :
   :
shell# mkfs-vfat /dev/sdc1
shell# mkfs.ext3 /dev/sdc2
````

### Write to SD-Card

````
shell# mount /dev/sdc1 /mnt/usb1
shell# mount /dev/sdc2 /mnt/usb2
shell# cp boot/*                            /mnt/usb1
shell# tar xfz debian8-rootfs-4.8.17.tgz -C /mnt/usb2
shell# umount mnt/usb1
shell# umount mnt/usb2
````

Build
------------------------------------------------------------------------------------

### Build Debian8 RootFS

#### Setup parameters 

```
shell$ apt-get install qemu-user-static debootstrap binfmt-support
shell$ export targetdir=debian8-rootfs
shell$ export distro=jessie
```

#### Build the root file system in $targetdir(=debian8-rootfs)

```
shell$ mkdir $targetdir
shell$ sudo debootstrap --arch=armhf --foreign $distro                       $targetdir
shell$ sudo cp /usr/bin/qemu-arm-static                                      $targetdir/usr/bin
shell$ sudo cp /etc/resolv.conf                                              $targetdir/etc
shell$ sudo cp scripts/build-debian8-rootfs-with-qemu.sh                     $targetdir
````

#### Build debian8-rootfs with QEMU

##### Change Root to debian8-rootfs

```
shell$ sudo chroot $targetdir
```

There are two ways

1. run build-debian8-rootfs-with-qemu.sh (easy)
2. run this chapter step-by-step (annoying)

##### Setup APT

````
debian8-rootfs# distro=jessie
debian8-rootfs# export LANG=C
debian8-rootfs# /debootstrap/debootstrap --second-stage
````

```
debian8-rootfs# cat <<EOT > /etc/apt/sources.list
deb     http://ftp.jp.debian.org/debian            jessie         main contrib non-free
deb-src http://ftp.jp.debian.org/debian            jessie         main contrib non-free
deb     http://ftp.jp.debian.org/debian            jessie-updates main contrib non-free
deb-src http://ftp.jp.debian.org/debian            jessie-updates main contrib non-free
deb     http://security.debian.org/debian-security jessie/updates main contrib non-free
deb-src http://security.debian.org/debian-security jessie/updates main contrib non-free
EOT
```

```
debian8-rootfs# cat <<EOT > /etc/apt/apt.conf.d/71-no-recommends
APT::Install-Recommends "0";
APT::Install-Suggests   "0";
EOT
```

```
debian8-rootfs# apt-get update
```

##### Install applications

```
debian8-rootfs# apt-get install -y locales dialog
debian8-rootfs# dpkg-reconfigure locales
debian8-rootfs# apt-get install -y openssh-server ntpdate resolvconf sudo less hwinfo ntp tcsh zsh
```

##### Setup hostname

```
debian8-rootfs# echo pynq > /etc/hostname
```

##### Setup root password

```
debian8-rootfs# passwd
```

This time, we set the "admin" at the root' password.

To be able to login as root from Zynq serial port.

```
debian8-rootfs# cat <<EOT >> /etc/securetty
# Seral Port for Xilinx Zynq
ttyPS0
EOT
```

##### Add a new guest user

```
debian8-rootfs# adduser fpga
```

This time, we set the "fpga" at the fpga'password.

```
debian8-rootfs# echo "fpga ALL=(ALL:ALL) ALL" > /etc/sudoers.d/fpga
```

##### Setup sshd config

```
debian8-rootfs# sed -i -e 's/#PasswordAuthentication/PasswordAuthentication/g' /etc/ssh/sshd_config
```

##### Setup Time Zone

```
debian8-rootfs# dpkg-reconfigure tzdata
```

or if noninteractive set to Asia/Tokyo

```
debian8-rootfs# echo "Asia/Tokyo" > /etc/timezone
debian8-rootfs# dpkg-reconfigure -f noninteractive tzdata
```


##### Setup fstab

```
debian8-rootfs# cat <<EOT > /etc/fstab
/dev/mmcblk0p1	/boot	auto		defaults	0	0
none		/config	configfs	defaults	0	0
EOT
````

##### Setup Network Interface

```
debian8-rootfs# cat <<EOT > /etc/network/interfaces.d/eth0
allow-hotplug eth0
iface eth0 inet dhcp
EOT
````

##### Install Development applications

```
debian8-rootfs# apt-get install -y build-essential
debian8-rootfs# apt-get install -y device-tree-compiler
debian8-rootfs# apt-get install -y u-boot-tools
debian8-rootfs# apt-get install -y socat
debian8-rootfs# apt-get install -y ruby ruby-msgpack ruby-serialport
debian8-rootfs# gem install rake
debian8-rootfs# apt-get install -y python  python-dev
debian8-rootfs# apt-get install -y python3 python3-dev
debian8-rootfs# wget https://bootstrap.pypa.io/get-pip.py
debian8-rootfs# python  ./get-pip.py
debian8-rootfs# apt-get install -y python-pip
debian8-rootfs# python3 ./get-pip.py
debian8-rootfs# apt-get install -y python3-pip
debian8-rootfs# rm get-pip.py
debian8-rootfs# pip3 install msgpack-rpc-python
debian8-rootfs# pip3 install jupyter
debian8-rootfs# apt-get install -y samba
debian8-rootfs# apt-get install -y avahi-daemon
```

##### Finish

```
debian8-rootfs# exit
shell$ sudo rm -f $targetdir/usr/bin/qemu-arm-static
shell$ sudo rm -f $targetdir/build-debian8-rootfs-with-qemu.sh
shell$ sudo mkdir $targetdir/root/debian
shell$ sudo cp    linux-image-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb   $targetdir/root/debian
shell$ sudo cp    linux-headers-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb $targetdir/root/debian
shell$ sudo cp    fpga-soc-linux-drivers-4.8.17-armv7-fpga_0.0.5-1_armhf.deb    $targetdir/root/debian
shell$ sudo cp    fpga-soc-linux-services_0.0.5-1_armhf.deb                     $targetdir/root/debian
```

#### Build debian8-rootfs-vanilla.tgz

```
shell$ cd $targetdir
shell$ sudo tar cfz ../debian8-rootfs-4.8.17.tgz *
```

